<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ðŸŽ¥ AI Video Call + ðŸ’¬ Chat</title>
  <style>
    :root{--bg:#f4f6f9;--accent:#0b76f6;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;color:#111}
    .app{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    input,button{padding:8px 10px;font-size:14px;border-radius:8px;border:1px solid #d1d5db}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer}
    button.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .stage{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:18px}
    .tile{background:#000;border-radius:10px;overflow:hidden;position:relative;height:160px}
    video{width:100%;height:100%;object-fit:cover;display:block}
    .label{position:absolute;left:8px;bottom:8px;background:rgba(0,0,0,0.45);color:#fff;padding:4px 8px;border-radius:6px;font-size:12px}
    .local .label{background:rgba(15,23,42,.6)}
    .chat{margin-top:18px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
    #messages{height:200px;overflow:auto;border-radius:8px;padding:8px;background:#f8fafc;border:1px solid #eef2ff}
    .msg{padding:6px 10px;border-radius:8px;margin:6px 0;display:inline-block;max-width:80%}
    .me{background:var(--accent);color:#fff;float:right}
    .peer{background:#eef2ff;color:#000;float:left}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:600px){.tile{height:140px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ðŸŽ¥ AI Video Call + ðŸ’¬ Chat</h1>
        <div class="small">Enter your name before joining â€” everyone will see who joined.</div>
      </div>
      <div class="small">Socket ID: <span id="sid">-</span></div>
    </header>

    <div class="controls">
      <label>Name: <input id="name" placeholder="Your name" /></label>
      <label>Room: <input id="room" value="testroom" /></label>
      <button id="joinBtn">Join Room</button>
      <button id="hangupBtn" class="ghost" disabled>Leave</button>

      <div style="width:1px;background:#e6edf3;margin:0 6px;height:28px"></div>

      <button id="flipBtn" disabled>Flip</button>
      <button id="muteBtn" disabled>Mute</button>
      <button id="camBtn" disabled>Cam Off</button>
    </div>

    <div class="stage" id="stage"></div>

    <div class="chat">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ðŸ’¬ Chat</h3>
        <div class="small">Participants: <span id="count">0</span></div>
      </div>
      <div id="messages"></div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <input id="chatInput" placeholder="Type message..." style="flex:1" />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const sidSpan = document.getElementById('sid');
    const nameInput = document.getElementById('name');
    const roomInput = document.getElementById('room');
    const joinBtn = document.getElementById('joinBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const flipBtn = document.getElementById('flipBtn');
    const muteBtn = document.getElementById('muteBtn');
    const camBtn = document.getElementById('camBtn');
    const stage = document.getElementById('stage');
    const messagesDiv = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const countSpan = document.getElementById('count');

    let localStream, videoTrack, currentDeviceId;
    let peers = {}; // id -> {pc, videoSender, videoEl}
    let room = null;
    const STUN = { urls: 'stun:stun.l.google.com:19302' };

    function makeTile(id, label, isLocal=false){
      const div=document.createElement('div'); div.className='tile '+(isLocal?'local':''); div.id='tile-'+id;
      const vid=document.createElement('video'); vid.autoplay=true; vid.playsInline=true; if(isLocal) vid.muted=true; vid.id='video-'+id;
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=label;
      div.append(vid,lab);
      return {div,vid};
    }

    function updateCount(){ countSpan.textContent=Object.keys(peers).length; }

    joinBtn.onclick = async ()=>{
      const name = nameInput.value.trim() || 'Anonymous';
      room = roomInput.value.trim();
      if(!room) return alert('Enter room');
      try{
        localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:true});
        videoTrack = localStream.getVideoTracks()[0];
        currentDeviceId = videoTrack.getSettings().deviceId || null;
        const {div,vid} = makeTile(socket.id, name+" (You)", true);
        stage.prepend(div);
        vid.srcObject=localStream;
        peers[socket.id]={videoEl:vid};
        socket.emit('join',{room,name});
        joinBtn.disabled=true; hangupBtn.disabled=false;
        flipBtn.disabled=false; muteBtn.disabled=false; camBtn.disabled=false;
      }catch(e){ alert("Camera/Mic error: "+e.message); }
    };

    socket.on('connect',()=> sidSpan.textContent=socket.id );

    socket.on('existingPeers', list=>{
      list.forEach(async p=>{
        if(p.id===socket.id) return;
        addRemote(p.id,p.name);
        await createPeer(p.id,true);
      });
    });

    socket.on('peer-joined',async ({id,name})=>{
      if(id===socket.id) return;
      addRemote(id,name);
      await createPeer(id,true);
    });

    socket.on('peer-left',({id})=> removePeer(id));

    socket.on('signal',async ({from,data})=>{
      if(!peers[from]) addRemote(from,'Peer');
      if(!peers[from].pc) await createPeer(from,false);
      const pc=peers[from].pc;
      if(data.type==='offer'){
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        const ans=await pc.createAnswer();
        await pc.setLocalDescription(ans);
        socket.emit('signal',{to:from,data:pc.localDescription});
      }else if(data.type==='answer'){
        await pc.setRemoteDescription(new RTCSessionDescription(data));
      }else if(data.candidate){
        try{await pc.addIceCandidate(new RTCIceCandidate(data.candidate));}catch(e){console.warn(e);}
      }
    });

    function addRemote(id,name){
      if(document.getElementById('tile-'+id)) return;
      const {div,vid}=makeTile(id,name);
      stage.append(div);
      peers[id]={videoEl:vid};
      updateCount();
    }

    function removePeer(id){
      if(peers[id]){ if(peers[id].pc) peers[id].pc.close(); const t=document.getElementById('tile-'+id); if(t)t.remove(); delete peers[id]; updateCount();}
    }

    async function createPeer(id,isInitiator){
      const pc=new RTCPeerConnection({iceServers:[STUN]});
      peers[id].pc=pc;
      pc.onicecandidate=e=>{if(e.candidate)socket.emit('signal',{to:id,data:{candidate:e.candidate}});};
      pc.ontrack=e=>{peers[id].videoEl.srcObject=e.streams[0];};
      if(localStream){
        localStream.getTracks().forEach(track=>{
          const sender=pc.addTrack(track,localStream);
          if(track.kind==='video') peers[id].videoSender=sender;
        });
      }
      if(isInitiator){
        const offer=await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('signal',{to:id,data:pc.localDescription});
      }
    }

    sendBtn.onclick=()=>{
      const text=chatInput.value.trim();
      if(!text)return;
      const name=nameInput.value.trim()||'Anonymous';
      socket.emit('chatMessage',{room,text});
      appendMsg('me',name+': '+text);
      chatInput.value='';
    };
    socket.on('chatMessage',({name,text})=> appendMsg('peer',name+': '+text) );

    function appendMsg(type,text){
      const d=document.createElement('div');
      d.className='msg '+(type==='me'?'me':'peer');
      d.textContent=text;
      messagesDiv.appendChild(d);
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    }

    hangupBtn.onclick=()=>{
      socket.emit('leave');
      Object.keys(peers).forEach(id=>{removePeer(id);});
      if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}
      joinBtn.disabled=false;hangupBtn.disabled=true;flipBtn.disabled=true;muteBtn.disabled=true;camBtn.disabled=true;
    };

    muteBtn.onclick=()=>{
      if(!localStream)return;
      const enabled=localStream.getAudioTracks()[0].enabled;
      localStream.getAudioTracks().forEach(t=>t.enabled=!enabled);
      muteBtn.textContent=enabled?'Unmute':'Mute';
    };

    camBtn.onclick=()=>{
      if(!localStream)return;
      const enabled=localStream.getVideoTracks()[0].enabled;
      localStream.getVideoTracks().forEach(t=>t.enabled=!enabled);
      camBtn.textContent=enabled?'Cam On':'Cam Off';
    };

    flipBtn.onclick=async()=>{
      const devices=await navigator.mediaDevices.enumerateDevices();
      const vids=devices.filter(d=>d.kind==='videoinput');
      if(vids.length<2)return alert('No second camera found');
      let idx=vids.findIndex(v=>v.deviceId===currentDeviceId);
      idx=(idx+1)%vids.length;
      const nextId=vids[idx].deviceId;
      const newStream=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:nextId}}});
      const newTrack=newStream.getVideoTracks()[0];
      localStream.removeTrack(videoTrack); videoTrack.stop();
      localStream.addTrack(newTrack); videoTrack=newTrack; currentDeviceId=nextId;
      document.getElementById('video-'+socket.id).srcObject=localStream;
      Object.values(peers).forEach(p=>{
        if(p.videoSender)p.videoSender.replaceTrack(videoTrack);
      });
    };
  </script>
</body>
</html>
